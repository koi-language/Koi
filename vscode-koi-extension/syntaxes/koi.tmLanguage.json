{
  "$schema": "https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json",
  "name": "Koi",
  "scopeName": "source.koi",
  "patterns": [
    { "include": "#comments" },
    { "include": "#import-declaration" },
    { "include": "#package-declaration" },
    { "include": "#role-declaration" },
    { "include": "#agent-declaration" },
    { "include": "#team-declaration" },
    { "include": "#skill-declaration" },
    { "include": "#mcp-declaration" },
    { "include": "#prompt-declaration" },
    { "include": "#uses-mcp" },
    { "include": "#run-statement" },
    { "include": "#keywords" },
    { "include": "#strings" },
    { "include": "#playbook" },
    { "include": "#numbers" },
    { "include": "#operators" },
    { "include": "#functions" },
    { "include": "#types" },
    { "include": "#constants" }
  ],
  "repository": {
    "import-declaration": {
      "match": "\\b(import)(?=\\s+[\"'](?!\"\"))",
      "name": "keyword.control.import.koi"
    },
    "comments": {
      "patterns": [
        {
          "name": "comment.line.double-slash.koi",
          "begin": "//",
          "end": "$"
        },
        {
          "name": "comment.block.koi",
          "begin": "/\\*",
          "end": "\\*/"
        }
      ]
    },
    "package-declaration": {
      "match": "\\b(package)(?=\\s+[\"'](?!\"\"))",
      "name": "keyword.control.package.koi"
    },
    "role-declaration": {
      "begin": "\\b(role)\\s+(\\w+)\\s*\\{",
      "beginCaptures": {
        "1": { "name": "keyword.control.role.koi" },
        "2": { "name": "entity.name.type.role.koi" }
      },
      "end": "\\}",
      "patterns": [
        {
          "match": "\\b(can)\\s+(\\w+)",
          "captures": {
            "1": { "name": "keyword.control.can.koi" },
            "2": { "name": "entity.name.function.capability.koi" }
          }
        }
      ]
    },
    "agent-declaration": {
      "begin": "\\b([Aa]gent)\\s+(\\w+)\\s*:\\s*(\\w+)\\s*\\{",
      "beginCaptures": {
        "1": { "name": "keyword.control.agent.koi" },
        "2": { "name": "entity.name.class.agent.koi" },
        "3": { "name": "entity.name.type.role.koi" }
      },
      "end": "\\}",
      "patterns": [
        { "include": "#llm-config" },
        { "include": "#state-declaration" },
        { "include": "#event-handler" },
        { "include": "#keywords" },
        { "include": "#strings" },
        { "include": "#playbook" },
        { "include": "#comments" }
      ]
    },
    "team-declaration": {
      "begin": "\\b([Tt]eam)\\s+(\\w+)\\s*\\{",
      "beginCaptures": {
        "1": { "name": "keyword.control.team.koi" },
        "2": { "name": "entity.name.class.team.koi" }
      },
      "end": "\\}",
      "patterns": [
        {
          "match": "(\\w+)\\s*[:=]\\s*(\\w+)",
          "captures": {
            "1": { "name": "variable.other.property.koi" },
            "2": { "name": "entity.name.class.agent.koi" }
          }
        },
        { "include": "#comments" }
      ]
    },
    "skill-declaration": {
      "begin": "\\b([Ss]kill)\\s+(\\w+)\\s*\\{",
      "beginCaptures": {
        "1": { "name": "keyword.control.skill.koi" },
        "2": { "name": "entity.name.class.skill.koi" }
      },
      "end": "\\}",
      "patterns": [
        { "include": "#affordance" },
        { "include": "#agent-declaration" },
        { "include": "#team-declaration" },
        { "include": "#export-function" },
        { "include": "#comments" }
      ]
    },
    "mcp-declaration": {
      "begin": "\\b(mcp)\\s+(\\w+)\\s*=\\s*\\{",
      "beginCaptures": {
        "1": { "name": "keyword.control.mcp.koi" },
        "2": { "name": "entity.name.class.mcp.koi" }
      },
      "end": "\\}",
      "patterns": [
        {
          "match": "(\\w+)\\s*:",
          "captures": {
            "1": { "name": "variable.other.property.koi" }
          }
        },
        { "include": "#strings" },
        { "include": "#numbers" },
        { "include": "#comments" }
      ]
    },
    "prompt-declaration": {
      "patterns": [
        {
          "comment": "Compose prompt: export? prompt Name = compose { ... }",
          "begin": "(?:\\b(export)\\s+)?\\b(prompt)\\s+(\\w+)\\s*=\\s*(compose)\\s*\\{",
          "beginCaptures": {
            "1": { "name": "keyword.control.export.koi" },
            "2": { "name": "keyword.control.prompt.koi" },
            "3": { "name": "entity.name.function.prompt.koi" },
            "4": { "name": "keyword.control.compose.koi" }
          },
          "end": "\\}",
          "patterns": [
            { "include": "#compose-body" }
          ]
        },
        {
          "comment": "Parameterized prompt: export? prompt Name(params) = \"\"\"...\"\"\"",
          "begin": "(?:\\b(export)\\s+)?\\b(prompt)\\s+(\\w+)\\s*(\\([^)]*\\))\\s*=\\s*(\"\"\")",
          "beginCaptures": {
            "1": { "name": "keyword.control.export.koi" },
            "2": { "name": "keyword.control.prompt.koi" },
            "3": { "name": "entity.name.function.prompt.koi" },
            "4": { "patterns": [{ "include": "#prompt-params" }] },
            "5": { "name": "string.quoted.triple.delimiter.koi" }
          },
          "end": "\"\"\"",
          "endCaptures": {
            "0": { "name": "string.quoted.triple.delimiter.koi" }
          },
          "contentName": "string.quoted.triple.prompt.koi",
          "patterns": [
            { "include": "#template-variable" }
          ]
        },
        {
          "comment": "Simple prompt: export? prompt Name = \"\"\"...\"\"\"",
          "begin": "(?:\\b(export)\\s+)?\\b(prompt)\\s+(\\w+)\\s*=\\s*(\"\"\")",
          "beginCaptures": {
            "1": { "name": "keyword.control.export.koi" },
            "2": { "name": "keyword.control.prompt.koi" },
            "3": { "name": "entity.name.function.prompt.koi" },
            "4": { "name": "string.quoted.triple.delimiter.koi" }
          },
          "end": "\"\"\"",
          "endCaptures": {
            "0": { "name": "string.quoted.triple.delimiter.koi" }
          },
          "contentName": "string.quoted.triple.prompt.koi",
          "patterns": [
            { "include": "#template-variable" }
          ]
        }
      ]
    },
    "compose-body": {
      "patterns": [
        { "include": "#compose-fragments" },
        {
          "comment": "compose keys: model, rules",
          "match": "\\b(model|rules)\\s*(?=:)",
          "captures": {
            "1": { "name": "keyword.other.compose.koi" }
          }
        },
        { "include": "#strings" },
        { "include": "#comments" }
      ]
    },
    "compose-fragments": {
      "begin": "\\b(fragments)\\s*:\\s*\\{",
      "beginCaptures": {
        "1": { "name": "keyword.other.compose.koi" }
      },
      "end": "\\}",
      "patterns": [
        {
          "comment": "fragment pair: alias: PromptRef",
          "match": "(\\w+)\\s*:\\s*(\\w+)",
          "captures": {
            "1": { "name": "variable.other.property.koi" },
            "2": { "name": "entity.name.function.prompt-ref.koi" }
          }
        },
        { "include": "#comments" }
      ]
    },
    "prompt-params": {
      "patterns": [
        {
          "match": "(\\w+)\\s*:\\s*(\\w+)",
          "captures": {
            "1": { "name": "variable.parameter.koi" },
            "2": { "name": "entity.name.type.koi" }
          }
        },
        {
          "name": "punctuation.separator.koi",
          "match": ","
        }
      ]
    },
    "uses-mcp": {
      "match": "\\b(uses)\\s+(mcp)\\s+(\\w+(?:\\s*,\\s*\\w+)*)",
      "captures": {
        "1": { "name": "keyword.control.uses.koi" },
        "2": { "name": "keyword.control.mcp.koi" },
        "3": { "name": "entity.name.class.mcp.koi" }
      }
    },
    "llm-config": {
      "begin": "\\b(llm)\\s+(default)\\s*=\\s*\\{",
      "beginCaptures": {
        "1": { "name": "keyword.control.llm.koi" },
        "2": { "name": "keyword.control.default.koi" }
      },
      "end": "\\}",
      "patterns": [
        {
          "match": "(\\w+)\\s*:",
          "captures": {
            "1": { "name": "variable.other.property.koi" }
          }
        },
        { "include": "#strings" },
        { "include": "#numbers" }
      ]
    },
    "state-declaration": {
      "begin": "\\b(state)\\s*\\{",
      "beginCaptures": {
        "1": { "name": "keyword.control.state.koi" }
      },
      "end": "\\}",
      "patterns": [
        {
          "match": "(\\w+)\\s*:\\s*(\\w+)\\s*(=)?",
          "captures": {
            "1": { "name": "variable.other.property.koi" },
            "2": { "name": "entity.name.type.koi" },
            "3": { "name": "keyword.operator.assignment.koi" }
          }
        },
        { "include": "#numbers" },
        { "include": "#strings" }
      ]
    },
    "event-handler": {
      "begin": "\\b(on)\\s+(\\w+)\\s*\\(([^)]*)\\)\\s*\\{",
      "beginCaptures": {
        "1": { "name": "keyword.control.on.koi" },
        "2": { "name": "entity.name.function.event.koi" },
        "3": { "patterns": [{ "include": "#function-params" }] }
      },
      "end": "\\}",
      "patterns": [
        { "include": "#playbook" },
        { "include": "#keywords" },
        { "include": "#strings" },
        { "include": "#numbers" },
        { "include": "#operators" },
        { "include": "#comments" }
      ]
    },
    "affordance": {
      "begin": "\\b(affordance)\\s+(\"\"\")",
      "beginCaptures": {
        "1": { "name": "keyword.control.affordance.koi" },
        "2": { "name": "string.quoted.triple.delimiter.koi" }
      },
      "end": "\"\"\"",
      "endCaptures": {
        "0": { "name": "string.quoted.triple.delimiter.koi" }
      },
      "name": "string.quoted.triple.affordance.koi"
    },
    "playbook": {
      "patterns": [
        {
          "comment": "Composed playbook: playbook Parts + ... + \"\"\"...\"\"\"",
          "begin": "\\b(playbook)\\s+((?:[A-Za-z_]\\w*(?:\\([^)]*\\))?\\s*\\+\\s*)+)(\"\"\")",
          "beginCaptures": {
            "1": { "name": "keyword.control.playbook.koi" },
            "2": { "patterns": [{ "include": "#playbook-composition-parts" }] },
            "3": { "name": "string.quoted.triple.delimiter.koi" }
          },
          "end": "\"\"\"",
          "endCaptures": {
            "0": { "name": "string.quoted.triple.delimiter.koi" }
          },
          "contentName": "string.quoted.triple.playbook.koi",
          "patterns": [
            { "include": "#template-variable" }
          ]
        },
        {
          "comment": "Simple playbook: playbook \"\"\"...\"\"\"",
          "begin": "\\b(playbook)\\s+(\"\"\")",
          "beginCaptures": {
            "1": { "name": "keyword.control.playbook.koi" },
            "2": { "name": "string.quoted.triple.delimiter.koi" }
          },
          "end": "\"\"\"",
          "endCaptures": {
            "0": { "name": "string.quoted.triple.delimiter.koi" }
          },
          "contentName": "string.quoted.triple.playbook.koi",
          "patterns": [
            { "include": "#template-variable" }
          ]
        },
        {
          "comment": "Playbook with only refs/calls (no string)",
          "match": "\\b(playbook)\\s+([A-Za-z_]\\w*(?:\\([^)]*\\))?(?:\\s*\\+\\s*[A-Za-z_]\\w*(?:\\([^)]*\\))?)*)",
          "captures": {
            "1": { "name": "keyword.control.playbook.koi" },
            "2": { "patterns": [{ "include": "#playbook-composition-parts" }] }
          }
        }
      ]
    },
    "playbook-composition-parts": {
      "patterns": [
        {
          "comment": "Prompt call: Name(args)",
          "match": "\\b([A-Z][a-zA-Z0-9_]*)(?=\\s*\\()",
          "captures": {
            "1": { "name": "entity.name.function.prompt-ref.koi" }
          }
        },
        {
          "comment": "Prompt reference: PascalCase identifier",
          "match": "\\b([A-Z][a-zA-Z0-9_]*)\\b",
          "captures": {
            "1": { "name": "entity.name.function.prompt-ref.koi" }
          }
        },
        {
          "name": "keyword.operator.composition.koi",
          "match": "\\+"
        },
        { "include": "#strings" }
      ]
    },
    "template-variable": {
      "name": "variable.other.template.koi",
      "match": "\\$\\{[^}]+\\}"
    },
    "export-function": {
      "begin": "\\b(export)\\s+(async)?\\s*(function)\\s+(\\w+)",
      "beginCaptures": {
        "1": { "name": "keyword.control.export.koi" },
        "2": { "name": "keyword.control.async.koi" },
        "3": { "name": "keyword.control.function.koi" },
        "4": { "name": "entity.name.function.koi" }
      },
      "end": "(?<=\\})",
      "patterns": [
        { "include": "#keywords" },
        { "include": "#strings" },
        { "include": "#operators" }
      ]
    },
    "run-statement": {
      "match": "\\b(run)\\s+(\\w+)\\.(\\w+)",
      "captures": {
        "1": { "name": "keyword.control.run.koi" },
        "2": { "name": "entity.name.class.koi" },
        "3": { "name": "entity.name.function.koi" }
      }
    },
    "keywords": {
      "patterns": [
        {
          "name": "keyword.control.koi",
          "match": "\\b(package|import|role|agent|team|skill|mcp|prompt|compose|on|playbook|run|export|function|async|await|send|timeout|state|llm|default|can|uses|peers|affordance|event|any|all|amnesia)\\b"
        },
        {
          "name": "keyword.control.flow.koi",
          "match": "\\b(if|else|return|while|for|break|continue)\\b"
        },
        {
          "name": "storage.type.koi",
          "match": "\\b(const|let|var)\\b"
        }
      ]
    },
    "strings": {
      "patterns": [
        {
          "name": "string.quoted.triple.koi",
          "begin": "\"\"\"",
          "end": "\"\"\"",
          "patterns": [
            { "include": "#template-variable" }
          ]
        },
        {
          "name": "string.quoted.double.koi",
          "begin": "\"",
          "end": "\"",
          "patterns": [
            {
              "name": "constant.character.escape.koi",
              "match": "\\\\."
            }
          ]
        },
        {
          "name": "string.quoted.single.koi",
          "begin": "'",
          "end": "'",
          "patterns": [
            {
              "name": "constant.character.escape.koi",
              "match": "\\\\."
            }
          ]
        }
      ]
    },
    "numbers": {
      "patterns": [
        {
          "name": "constant.numeric.float.koi",
          "match": "\\b\\d+\\.\\d+([eE][+-]?\\d+)?\\b"
        },
        {
          "name": "constant.numeric.integer.koi",
          "match": "\\b\\d+\\b"
        }
      ]
    },
    "operators": {
      "patterns": [
        {
          "name": "keyword.operator.comparison.koi",
          "match": "(==|!=|<=|>=|<|>)"
        },
        {
          "name": "keyword.operator.logical.koi",
          "match": "(&&|\\|\\||!)"
        },
        {
          "name": "keyword.operator.assignment.koi",
          "match": "(=|\\+=|-=|\\*=|/=)"
        },
        {
          "name": "keyword.operator.arithmetic.koi",
          "match": "(\\+|-|\\*|/|%)"
        }
      ]
    },
    "types": {
      "name": "entity.name.type.koi",
      "match": "\\b(Json|Int|String|Bool|Float|Array|Object|Promise|any)\\b"
    },
    "constants": {
      "name": "constant.language.koi",
      "match": "\\b(true|false|null|undefined)\\b"
    },
    "functions": {
      "match": "\\b(\\w+)\\s*\\(",
      "captures": {
        "1": { "name": "entity.name.function.koi" }
      }
    },
    "function-params": {
      "patterns": [
        {
          "match": "(\\w+)\\s*:\\s*(\\w+)",
          "captures": {
            "1": { "name": "variable.parameter.koi" },
            "2": { "name": "entity.name.type.koi" }
          }
        }
      ]
    }
  }
}
