// Registry with Natural Language Playbooks Demo
// Shows how agents can use registry operations naturally in playbooks
package "registry.playbook.demo"

role Worker { can execute, can registry }
role Manager { can execute, can delegate }

// Agent that uses natural language to interact with registry
Agent UserManager : Worker {
  llm default = { provider: "openai", model: "gpt-4o-mini" }

  on createAllUser(args: Json) {
    playbook """
    Create all given users via args, with the following attributes
    - name, age, email

    Save all to registry with key "user:id being id an unique identifier".
    Include all fields plus a createdAt timestamp.
    Return: { "success": true, "message": "Users created" }

    DO NOT add print actions - just return the data.
    """
  }

  on createUser(args: Json) {
    playbook """
    Create a new user with:
    - name: ${args.name}
    - age: ${args.age}
    - email: ${args.email}

    Save to registry with key "user:${args.id}".
    Include all fields plus a createdAt timestamp.
    Return: { "success": true, "message": "User created" }

    DO NOT add print actions - just return the data.
    """
  }

  on getUser(args: Json) {
    playbook """
    Get user ${args.id} from registry.

    Use registry_get with key "user:${args.id}".
    Extract the .value field from the registry_get result (which contains the user data).
    Return ONLY the user data object (name, age, email, createdAt) without any wrapper.
    """
  }

  on listAllUsers(args: Json) {
    playbook """
    List all users in the registry.

    EXACT STEPS:
    1. Use registry_search with an empty query {} to get ALL users, store with ID "a1"
    2. Extract just the user data (the .value field) from each result
    3. Return: { "count": <count from a1>, "users": <array of user value objects, NOT the full {key, value} wrappers> }

    Example: If a1.output.results = [{key: "user:001", value: {name: "Alice", age: 30}}, ...]
    Then return: { "count": 2, "users": [{name: "Alice", age: 30}, ...] }

    CRITICAL: Extract ONLY the .value objects so caller can access with .users[0].name directly
    DO NOT use format action - return a real array!
    """
  }

  on findAdults(args: Json) {
    playbook """
    Find all users aged 18 or older using registry search with query: { "age": { "$gte": 18 } }

    EXACT STEPS:
    1. Use registry_search with query: { "age": { "$gte": 18 } }
    2. Return: { "count": [count from search], "adults": [results array] }

    DO NOT add print actions - just return the data!
    """
  }

  on updateUserAge(args: Json) {
    playbook """
    Update user ${args.id}'s age to ${args.age}.

    EXACT STEPS:
    1. Use registry_get with key "user:${args.id}", store with ID "a1"
    2. Take the full user object from \${a1.output.value}
    3. Modify ONLY the age field to ${args.age}, keep all other fields (name, email, createdAt, etc.)
    4. Use registry_set with key "user:${args.id}" and the complete updated object
    5. Return: { "success": true, "message": "Age updated" }

    CRITICAL: Preserve ALL existing fields when saving!
    """
  }

  on deleteUser(args: Json) {
    playbook """
    Borra el usuario del registro con ID ${args.id}.

    EXACT STEPS:
    1. Use registry_delete with key "user:\${args.id}"
    2. Return: { "success": true, "message": "User deleted" }
    """
  }
}

// Team that groups our agents
Team RegistryTeam {
  userManager = UserManager
}

// Orchestrator - uses playbook, router finds UserManager automatically!
Agent Demo : Manager {
  llm default = { provider: "openai", model: "gpt-4o-mini" }
  uses Team RegistryTeam

  on start(args: Json) {
    //SUPER IMPORTANT: DO NOT CHANGE THE FOLLOWING PROMPT AT ALL!!!!!!
    playbook """
    Ejecuta un demo del registro de usuarios.

    Muestra el header:
    ╔══════════════════════════════════════════════════╗
    ║  Registry with Playbook Demo                     ║
    ╚══════════════════════════════════════════════════╝

    1️⃣ Crea estos usuarios:
    - Alice: id=001, age=30, email=alice@example.com
    - Bob: id=002, de 17 años, bob@example.com
    - Charlie: id=003, age=25, email=charlie@example.com
    - Diana: id=004, age is 35, diana@example.com
    - Erika: id=005, age=28, email=erika@example.com
    - Fernando: id=006, age=32, fernando@example.com
    Muestra: "   ✅ X users created" X es la cantidad de usuarios que se crearon

    2️⃣ Obtén el usuario 001
    Muestra: "   ✅ Found user: {el nombre del usuario}, age {su edad}"

    3️⃣ Lista todos los usuarios
    Muestra: "   ✅ Found {la cantidad de usuarios} users y luego por cada uno muestra en una tabla en markdown: sr o sra si es chico o chica (esto deducelo por el nombre) y luego {el nombre del usuario}, age {su edad}"

    4️⃣ Busca usuarios mayores de 18 años
    Muestra: "   ✅ Found {la cantidad encontrada} adults"

    5️⃣ Actualiza la edad de Bob (002) a 19 años
    Luego obtén el usuario actualizado
    Muestra: "   ✅ Bob is now {su nueva edad} years old"

    6️⃣ Elimina a Charlie (003)
    Luego lista los usuarios restantes
    Muestra: "   ✅ Remaining users: {la cantidad restante}"

    7️⃣ Vuelve a listar todos los usuarios como lo has hecho en el paso 3️⃣
    Muestra los usuarios que hay en la tabla en markdown con el mismo formato que en el paso 3️⃣

    Muestra el footer:
    ╔══════════════════════════════════════════════════╗
    ║  Demo completed successfully!                    ║
    ╚══════════════════════════════════════════════════╝
    """
  }
}

run Demo.start({})
