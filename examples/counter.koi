// ============================================================
// Koi â€” Counter Example
// Simple stateful agent that counts using playbooks
// ============================================================

role Worker { can execute }
role Coordinator { can execute, can delegate }

agent Counter : Worker {
  llm default = { provider: "openai", model: "gpt-4o-mini", temperature: 0.1, max_tokens: 200 }
  amnesia = true

  state {
    count: Int = 0
  }

  on increment(args: Json) {
    playbook """
    You are a counter agent. Increment the internal counter by 1.
    Current count: ${state.count}
    Calculate the new count and return it. Use state_updates to persist the new value.
    """
  }

  on get(args: Json) {
    playbook """
    You are a counter agent. Return the current counter value without modifying it.
    Current count: ${state.count}
    """
  }

  on reset(args: Json) {
    playbook """
    You are a counter agent. Reset the counter to zero.
    Current count: ${state.count}
    Reset to 0 and return. Use state_updates to persist the new value.
    """
  }

  on incrementBy(args: Json) {
    playbook """
    You are a counter agent. Increment the counter by a specific amount.
    Current count: ${state.count}
    Amount to add: ${args.amount || 1}
    Calculate the new count and return it. Use state_updates to persist the new value.
    """
  }
}

team CounterTeam {
  counter: Counter
}

agent Orchestrator : Coordinator {
  uses team CounterTeam

  on start(args: Json) {
    console.log("ğŸ”¢ Counter Test Starting...")
    console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")

    const r1 =
      await send peers.event("increment").role(Worker).any()({}) timeout 30s
    console.log("âœ“ After increment 1:", r1)

    const r2 =
      await send peers.event("increment").role(Worker).any()({}) timeout 305s
    console.log("âœ“ After increment 2:", r2)

    const r3 =
      await send peers.event("increment").role(Worker).any()({}) timeout 305s
    console.log("âœ“ After increment 3:", r3)

    const current =
      await send peers.event("get").role(Worker).any()({}) timeout 30s
    console.log("âœ“ Current value:", current)

    console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")

    return { message: "Counter test complete âœ“", final: current }
  }
}

run Orchestrator.start({})
